[Phần 2 - Tổng quan về kiến trúc Linux](https://github.com/volehuy1998/network-onboard/blob/master/README.md)

- [2.1 - Linux Kernel (UPDATED 21/01/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.1%20-%20linux-arch-onboard.md#linux_kernel)
  - 2.1.1 - Vai trò của Linux Kernel (UPDATED 21/01/2024)
  - 2.1.2 - Tổng quan về Interrupt - Ngắt (UPDATED 05/09/2023)
- [2.2 - Quản lý người dùng và nhóm ( :arrow_up: UPDATED 15/04/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.2%20-%20linux-user-management.md#user_and_group)
  - 2.2.1 - Khái niệm `User` (UPDATED 17/09/2023)
  - 2.2.2 - Khái niệm về nhóm, chính và phụ (UPDATED 12/09/2023)
  - 2.2.3 - Thay đổi tài khoản người dùng (UPDATED 13/09/2023)
  - 2.2.4 - Các thao tác quản lý trên người dùng và nhóm(UPDATED 11/09/2023)
  - 2.2.5 - Hạn chế quyền truy cập người dùng (UPDATED 13/09/2023)
  - 2.2.6 - Cấp quyền `sudo` cho nhóm `wheel` ( :arrow_up: UPDATED 15/04/2024)
  - 2.2.7 - Cấp quyền `sudo` cụ thể ( :arrow_up: UPDATED 15/04/2024)
- [2.3 - Hệ thống tệp tin (UPDATED 07/01/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.3%20-%20linux-file-system-overview.md#fs)
  - 2.3.1 - Phân cấp hệ thống tệp tin (UPDATED 26/08/2023)
  - 2.3.2 - RPM Package và phân loại (UPDATED 24/08/2023)
  - 2.3.3 - Kernel RPM Package (UPDATED 24/08/2023)
  - 2.3.4 - Tổng quan về quyền trên tệp tin (UPDATED 07/01/2024)
    - 2.3.4.1 - Quản lý quyền tệp tin (UPDATED 13/09/2023)
    - 2.3.4.2 - Quyền đặc biệt dành cho chủ sở hữu (SUID) và lỗ hổng leo thang đặc quyền (UPDATED 10/09/2023)
    - 2.3.4.3 - Quyền đặc biệt dành cho nhóm (UPDATED 10/09/2023)
    - 2.3.4.4 - Quyền đặc biệt Sticky bit (UPDATED 04/09/2023)
  - 2.3.5 - Xác định hệ thống tệp tin và thiết bị (UPDATED 07/11/2023)
- [2.4 - Tổng quan tiến trình Linux (UPDATED 04/10/2023)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.4%20-%20linux-process-overview.md#linux_process)
  - 2.4.1 - Trạng thái của tiến trình Linux (UPDATED 17/09/2023)
  - 2.4.2 - Kiểm soát các `Job` (UPDATED 04/10/2023)
  - 2.4.3 - Kết thúc tiến trình (UPDATED 18/09/2023)
  - 2.4.4 - Dịch vụ hạ tầng (UPDATED 21/09/2023)
  - 2.4.5 - Tổng quan về `systemd` (UPDATED 30/09/2023)
  - 2.4.6 - Kiểm soát dịch vụ hệ thống (UPDATED 04/10/2023)
  - 2.4.7 - Mẫu `unit` với ký hiệu `@` (UPDATED 04/10/2023)
  - 2.4.8 - Chi tiết tệp `unit` (UPDATED 04/10/2023)
    - 2.4.8.1 - Loại `unit` phổ biến `*.service` (UPDATED 03/10/2023)
    - 2.4.8.2 - Loại `unit` về `*.socket` (UPDATED 30/09/2023)
    - 2.4.8.3 - Loại `unit` về `*.path` (UPDATED 30/09/2023)
- [2.5 - Điều khiển an toàn từ xa (UPDATED 31/12/2023)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.5%20-%20linux-secure-remote-overview.md#remote_connection)
  - 2.5.1 - Tổng quan về kiến trúc giao thức `SSH` (UPDATED 31/12/2023)
    - 2.5.1.1 - Kiến trúc giao thức `SSH` (UPDATED 22/10/2023)
    - 2.5.1.2 - Những xem xét bảo mật về khía cạnh truyền dẫn (UPDATED 19/10/2023)
    - 2.5.1.3 - Những xem xét bảo mật về khía cạnh xác thực (UPDATED 19/10/2023)
    - 2.5.1.4 - Giao thức `SSH-1`, `SSH-2` và sự cải tiến (UPDATED 22/10/2023)
  - 2.5.2 - Cài đặt `OpenSSH`, kết nối và cấu hình (UPDATED 23/10/2023)
    - 2.5.2.1 - Sử dụng công cụ cơ bản (UPDATED 19/10/2023)
    - 2.5.2.2 - Thông tin về `finger print` tại máy khách và máy chủ (UPDATED 19/10/2023)
    - 2.5.2.3 - Hành vi xử lý chuẩn kết nối đến máy chủ (UPDATED 19/10/2023)
    - 2.5.2.4 - Cấu hình `ssh client` (UPDATED 21/10/2023)
    - 2.5.2.5 - Sử dụng `X11 Forwarding` và `Port Forwarding` (UPDATED 23/10/2023)
- [2.6 - Tổng quan về quản lý mạng (UPDATED 05/11/2023)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.6%20-%20linux-network-overview.md#network_manage)
  - 2.6.1 - Mô hình `TCP/IP` (UPDATED 25/10/2023)
  - 2.6.2 - Mô tả về `Network Interface` (UPDATED 01/11/2023)
  - 2.6.3 - Địa chỉ `v4` (UPDATED 25/10/2023)
  - 2.6.4 - Địa chỉ `v6` (UPDATED 25/10/2023)
  - 2.6.5 - Thông tin về `network interface`(UPDATED 25/10/2023)
  - 2.6.6 - Công cụ quản lý `nmcli`(UPDATED 05/11/2023)
  - 2.6.7 - Cấu hình và quản lý `hostname`(UPDATED 05/11/2023)
- [2.7 - Kiến trúc nhật ký hệ thống (UPDATED 17/12/2023)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.7%20-%20linux-system-log-architecture-overview.md#sys_log_arch)
  - 2.7.1 - Tổng quan (UPDATED 03/12/2023)
  - 2.7.2 - Cách sử dụng `rsyslog` (UPDATED 06/12/2023)
  - 2.7.3 - Cách sử dụng `systemd-journald` (UPDATED 10/12/2023)
  - 2.7.4 - Đồng bộ thời gian (UPDATED 17/12/2023)
    - 2.7.4.1 - Tổng quan `Network Time Protocol` (UPDATED 17/12/2023)
    - 2.7.4.2 - Công cụ `datetimectl` (UPDATED 10/12/2023)
    - 2.7.4.3 - Cấu hình `NTP` sử dụng `chrony` (UPDATED 17/12/2023)
    - 2.7.4.4 - Cấu hình `NTP` sử dụng `ntpd` (UPDATED 10/12/2023)
- [2.8 - Lập lịch chạy cho tác vụ tương lai (UPDATED 01/01/2024)](#schedule_job)
  - [2.8.1 - Tổng quan (UPDATED 24/12/2023)](#sche_job_overview)
  - [2.8.2 - Cách sử dụng công cụ `at` (UPDATED 24/12/2023)](#at)
  - [2.8.3 - Cách sử dụng công cụ `cron` (UPDATED 24/12/2023)](#cron)
  - [2.8.4 - Ứng dụng `systemd timer` (UPDATED 01/01/2024)](#systemd_timer)
    - [2.8.4.1 - Cách sử dụng công cụ `systemd timer` (UPDATED 01/01/2024)](#systemd_timer_basic)
    - [2.8.4.2 - Quản lý loại tệp tạm thời (UPDATED 01/01/2024)](#manage_tmp_file)
      - [2.8.4.2.1 - Cách sử dụng `systemd-tmpfiles --create` (UPDATED 01/01/2024)](#tmpfiles_create)
      - [2.8.4.2.2 - Cách sử dụng `systemd-tmpfiles --clean` (UPDATED 01/01/2024)](#tmpfiles_clean)
      - [2.8.4.2.3 - Cách sử dụng `systemd-tmpfiles --remove` (UPDATED 01/01/2024)](#tmpfiles_remove)
- [2.9 - Quản lý tệp đóng gói và nén với công cụ `tar` (UPDATED 09/02/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.9%20-%20linux-manage-compressed-tar-archives.md#manage_compress_tar_archive)
    - 2.9.1 - Tạo và quản lý tệp đóng gói (UPDATED 09/02/2024)
    - 2.9.2 - Tạo và quản lý tệp nén đóng gói (UPDATED 15/01/2024)
    - 2.9.3 - Quản lý tệp sao lưu gia tăng `incremental backup` (UPDATED 15/01/2024)
    - 2.9.4 - Chuyển tệp giữa các hệ thống một cách an toàn (UPDATED 15/01/2024)
    - 2.9.5 - Đồng bộ giữa các hệ thống một cách an toàn (UPDATED 15/01/2024)
- [2.10 - Quản lý `SELinux` (UPDATED 28/01/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.10%20-%20linux-se-mode.md#selinux_manage)
    - 2.10.1 - Kiến trúc `SELinux` (UPDATED 27/01/2024)
    - 2.10.2 - Sử dụng `SELinux` cơ bản với chính sách `targeted` (UPDATED 28/01/2024)
      - 2.10.2.1 - Xem nhãn, kích hoạt và vô hiệu hóa `SELinux` (UPDATED 28/01/2024)
      - 2.10.2.2 - Xem định nghĩa chính sách `SELinux` (UPDATED 27/01/2024)
      - 2.10.2.3 - Auditing hành vi hệ thống (UPDATED 28/01/2024)
      - 2.10.2.4 - Kiểm soát `fcontext` với nhãn sẵn có (UPDATED 27/01/2024)
      - 2.10.2.5 - Kiểm soát `port` với nhãn sẵn có (UPDATED 27/01/2024)
      - 2.10.2.6 - Kiểm soát chính sách với  `boolean` (UPDATED 27/01/2024)
- [2.11 - Quản lý lưu trữ cơ bản ( :arrow_up: UPDATED 07/02/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.11%20-%20linux-manage-basic-storage.md#manage_basic_storage)
    - 2.11.1 - Khái niệm phân vùng ổ cứng ( :heavy_plus_sign: UPDATED 05/01/2024)
    - 2.11.2 - Quản lý phân vùng theo định dạng ( :heavy_plus_sign: UPDATED 05/01/2024)
      - 2.11.2.1 - Quản lý phân vùng định dạng MBR ( :arrow_up: UPDATED 07/02/2024)
      - 2.11.2.2 - Quản lý phân vùng định dạng GPT ( :heavy_plus_sign: UPDATED 05/01/2024)
    - 2.11.3 - Tạo tệp hệ thống (UPDATED 05/01/2024)
    - 2.10.4 - Mount tệp hệ thống ( :heavy_plus_sign: UPDATED 05/01/2024)
      - 2.11.4.1 - Mount thủ công tệp hệ thống (UPDATED 05/01/2024)
      - 2.11.4.2 - Mount tự vĩnh viễn tệp hệ thống (UPDATED 05/01/2024)
    - 2.11.5 - Quản lý không gian `Swap` (UPDATED 05/01/2024)
      - 2.11.5.1 - Khái niệm không gian `Swap` (UPDATED 05/01/2024)
      - 2.11.5.2 - Tạo phân vùng `swap` (UPDATED 05/01/2024)
- [2.12 - Quản lý lưu trữ nâng cao (UPDATED 09/02/2024)](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.12%20-%20linux-manage-advance-storage.md#manage_advance_storage)
  - 2.12.1 - Tổng quan Logical Volume Manager (LVM) (UPDATED 09/02/2024)
  - 2.12.2 - Xây dựng hệ thống lưu trữ LVM (UPDATED 09/02/2024)
  - 2.12.3 - Tạo Logical Volume tính năng nén và chống trùng lặp (UPDATED 09/02/2024)
      
## <a name="schedule_job"></a>Lập lịch chạy cho tác vụ tương lai
### <a name="sche_job_overview"></a>Tổng quan

Thỉnh thoảng có lẻ người dùng cần chạy một hoặc nhiều lệnh vào một thời điểm nào đó trong tương lai. Ví dụ người dùng lập lịch một tác vụ duy trì dài hạn xảy ra vào mỗi tối. Một ví dụ khác về  nhà quản trị hệ thống làm việc cấu hình tường lửa thông qua nhiều bước cấu hình an toàn. Người dùng có thể hủy bỏ lịch trình trước khi nó chạy. 

Những câu lệnh được lập lịch được gọi là `tasks` hoặc `job`, thời hạn bao gồm thời điểm và thời gian trì hoãn chỉ ra rằng tác vụ này sẽ chạy trong tương lai. Có 2 chế độ được sắp đặt lệnh là:

- `One off`: chỉ thực hiện một lần duy nhất.
- `Recurring`: lặp lại liên tục, sử dụng công cụ `contab` để lên lịch và trình chạy nền `crond` để quản lý.

### <a name="at"></a>Cách sử dụng `at`

Một trong những giải pháp được cài đặt và kích hoạt sẵn ở các bản phối `RHEL` là `at`, đối với các bản phân phối khác như `Ubuntu`, `CentOS` ... sẽ phải cần cài đặt. Công cụ `at` là chương trình triển khai theo `one off`. Gói `at` cung cấp trình chạy nền quản lý là `atd (at daemon)`, chương trình `at` và `atq`. Người dùng có thể có lên lịch các công việc cho `atd` thông qua `at`. Dịch vụ `atd` cung cấp tối đa `26` hàng đợi được sắp xếp theo bảng chữ cái từ `a` đến `z`.

Lệnh `at` sẽ đọc từ dữ liệu từ `STDIN` tức bàn phím, kết thúc bằng tổ hợp phím `Ctrl D`.

```shell
[root@huyvl-linux-training ~]# date
Sun Dec 24 13:03:12 +07 2023
[root@huyvl-linux-training ~]# ls -l   
total 0
[root@huyvl-linux-training ~]# at 13:04
at> mkdir hello
at> <EOT>
job 5 at Sun Dec 24 13:04:00 2023
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# atq
5       Sun Dec 24 13:04:00 2023 a root
[root@huyvl-linux-training ~]# ls -l
total 4
drwxr-xr-x 2 root root 4096 Dec 24 13:04 hello
[root@huyvl-linux-training ~]#   
[root@huyvl-linux-training ~]# atq
[root@huyvl-linux-training ~]# 
```

Ngoài cách đưa dữ liệu truyền thống từ bàn phím thì người dùng có thể sử dụng tệp kịch bản 
thông qua tùy chọn `-f` hoặc `<` như sau:

```shell
[root@huyvl-linux-training ~]# echo "mkdir goodbye" > weekend   
[root@huyvl-linux-training ~]# date
Sun Dec 24 13:05:36 +07 2023
[root@huyvl-linux-training ~]# at 13:07 < weekend 
job 6 at Sun Dec 24 13:07:00 2023
[root@huyvl-linux-training ~]# atq
6       Sun Dec 24 13:07:00 2023 a root
[root@huyvl-linux-training ~]# ls -l
total 8
drwxr-xr-x 2 root root 4096 Dec 24 13:04 hello
-rw-r--r-- 1 root root   18 Dec 24 13:05 weekend
[root@huyvl-linux-training ~]#
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# ls -l
total 12
drwxr-xr-x 2 root root 4096 Dec 24 13:07 goodbye
drwxr-xr-x 2 root root 4096 Dec 24 13:04 hello
-rw-r--r-- 1 root root   18 Dec 24 13:05 weekend
[root@huyvl-linux-training ~]# 
```

Trì hoãn một phút:

```shell
[root@huyvl-linux-training ~]# echo "mkdir good_morning" > monday
[root@huyvl-linux-training ~]# date                 
Sun Dec 24 13:09:14 +07 2023
[root@huyvl-linux-training ~]# ls -l                
total 16
drwxr-xr-x 2 root root 4096 Dec 24 13:07 goodbye
drwxr-xr-x 2 root root 4096 Dec 24 13:04 hello
-rw-r--r-- 1 root root   19 Dec 24 13:09 monday
-rw-r--r-- 1 root root   18 Dec 24 13:05 weekend
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# at now +1min < monday
job 7 at Sun Dec 24 13:10:00 2023
[root@huyvl-linux-training ~]# ls -l
total 20
drwxr-xr-x 2 root root 4096 Dec 24 13:10 good_morning
drwxr-xr-x 2 root root 4096 Dec 24 13:07 goodbye
drwxr-xr-x 2 root root 4096 Dec 24 13:04 hello
-rw-r--r-- 1 root root   19 Dec 24 13:09 monday
-rw-r--r-- 1 root root   18 Dec 24 13:05 weekend
[root@huyvl-linux-training ~]# 
```

Ngoài ra có thể triển khai theo những điểm thời gian khác nhau:

- `teatime tomorrow`: lúc `4:00` chiều ngày mai.
- `5pm august 3 2024`: lúc `5:00` chiều ngày 3 tháng 8 năm 2024.
- `noon +4 days`: buổi trưa `12:00` vào 4 ngày sau, có thể sử dụng `weeks`, `months`, `years`.
- `082017`: tương đương với `August 20 2017`.
- `midnight`: lúc `0:00` sáng ngày mai.
- `next week`: tuần sau vào giờ này.
- `2:30 PM tomorrow`: lúc `2:30` chiều ngày mai.

Liệt kê tất cả các `job` với `atq`, nếu người dùng là `root` thì có thể nhìn thấy tất cả. Trong đó lệnh `at -l` có cùng chức năng với `atq`.

```shell
[hcm-operator@huyvl-linux-training ~]$ echo "good evening" | at now +5min
job 10 at Sun Dec 24 17:34:00 2023
[hcm-operator@huyvl-linux-training ~]$ atq
10      Sun Dec 24 17:34:00 2023 a hcm-operator
8       Sun Dec 24 17:32:00 2023 a hcm-operator
[hcm-operator@huyvl-linux-training ~]$ 
[hcm-operator@huyvl-linux-training ~]$ exit
logout
[root@huyvl-linux-training ~]# atq
10      Sun Dec 24 17:34:00 2023 a hcm-operator
8       Sun Dec 24 17:32:00 2023 a hcm-operator
9       Sun Dec 24 17:32:00 2023 a root
[root@huyvl-linux-training ~]# 
```

Chú thích:

- Con sô định danh của tác vụ như ví dụ trên: `10`, `8`, `9`, ...
- Thời điểm sẽ thực thi: `Sun Dec 24 17:34:00 2023`, ...
- Ký tự `a` là hàng đợi mặc định hoặc `at -q a`, sẽ thực thi đúng thời điểm bất kể tải hệ thống như thế nào. Ngoài ra còn có hàng đợi `b (batch)` được tạo từ lệnh `batch` hoặc `at -q b`.
- `hcm-operator` hay `root` là tài khoản tạo ra tác vụ.

Lệnh `at -c <job-id>` sẽ phân tích tất cả nguồn lực và kịch bản để thực hiện tác vụ.

```shell
[root@huyvl-linux-training ~]# mkdir hello | at now +1min
job 16 at Sun Dec 24 17:56:00 2023
[root@huyvl-linux-training ~]# atq
16      Sun Dec 24 17:56:00 2023 a root
[root@huyvl-linux-training ~]# at -c 16
#!/bin/sh
# atrun uid=0 gid=0                                
# mail root 0                                      
umask 22                                           
LC_PAPER=vi_VN; export LC_PAPER                    
XDG_SESSION_ID=36; export XDG_SESSION_ID
LC_ADDRESS=vi_VN; export LC_ADDRESS                
HOSTNAME=huyvl-linux-training.novalocal; export HOSTNAME
LC_MONETARY=vi_VN; export LC_MONETARY              
SHELL=/bin/bash; export SHELL                      
HISTSIZE=1000; export HISTSIZE                     
SSH_CLIENT=171.252.189.201\ 5216\ 22; export SSH_CLIENT
LC_NUMERIC=vi_VN; export LC_NUMERIC                
SSH_TTY=/dev/pts/0; export SSH_TTY                 
LC_ALL=C; export LC_ALL                            
USER=root; export USER                             
LS_COLORS=rs=0:di=38\;5\;27:ln=38\;5\;51:mh=44\;38\;5\;15:pi=40\;38\;5\;11:so=38\;5\;13:do=38\;5\;5:bd=48\;5\;232\;38\;5\;11:cd=48\;5\;232\;38\;5\;3:or=48\;5\;232\;38\;5\;9:mi=05\;48\;5\;232\;38\;5\;15:su=48\;5\;196\;38\;5\;15:sg=48\;5\;11\;38\;5\;16:ca=48\;5\;196\;38\;5\;226:tw=48\;5\;10\;38\;5\;16:ow=48\;5\;10\;38\;5\;21:st=48\;5\;21\;38\;5\;15:ex=38\;5\;34:\*.tar=38\;5\;9:\*.tgz=38\;5\;9:\*.arc=38\;5\;9:\*.arj=38\;5\;9:\*.taz=38\;5\;9:\*.lha=38\;5\;9:\*.lz4=38\;5\;9:\*.lzh=38\;5\;9:\*.lzma=38\;5\;9:\*.tlz=38\;5\;9:\*.txz=38\;5\;9:\*.tzo=38\;5\;9:\*.t7z=38\;5\;9:\*.zip=38\;5\;9:\*.z=38\;5\;9:\*.Z=38\;5\;9:\*.dz=38\;5\;9:\*.gz=38\;5\;9:\*.lrz=38\;5\;9:\*.lz=38\;5\;9:\*.lzo=38\;5\;9:\*.xz=38\;5\;9:\*.bz2=38\;5\;9:\*.bz=38\;5\;9:\*.tbz=38\;5\;9:\*.tbz2=38\;5\;9:\*.tz=38\;5\;9:\*.deb=38\;5\;9:\*.rpm=38\;5\;9:\*.jar=38\;5\;9:\*.war=38\;5\;9:\*.ear=38\;5\;9:\*.sar=38\;5\;9:\*.rar=38\;5\;9:\*.alz=38\;5\;9:\*.ace=38\;5\;9:\*.zoo=38\;5\;9:\*.cpio=38\;5\;9:\*.7z=38\;5\;9:\*.rz=38\;5\;9:\*.cab=38\;5\;9:\*.jpg=38\;5\;13:\*.jpeg=38\;5\;13:\*.gif=38\;5\;13:\*.bmp=38\;5\;13:\*.pbm=38\;5\;13:\*.pgm=38\;5\;13:\*.ppm=38\;5\;13:\*.tga=38\;5\;13:\*.xbm=38\;5\;13:\*.xpm=38\;5\;13:\*.tif=38\;5\;13:\*.tiff=38\;5\;13:\*.png=38\;5\;13:\*.svg=38\;5\;13:\*.svgz=38\;5\;13:\*.mng=38\;5\;13:\*.pcx=38\;5\;13:\*.mov=38\;5\;13:\*.mpg=38\;5\;13:\*.mpeg=38\;5\;13:\*.m2v=38\;5\;13:\*.mkv=38\;5\;13:\*.webm=38\;5\;13:\*.ogm=38\;5\;13:\*.mp4=38\;5\;13:\*.m4v=38\;5\;13:\*.mp4v=38\;5\;13:\*.vob=38\;5\;13:\*.qt=38\;5\;13:\*.nuv=38\;5\;13:\*.wmv=38\;5\;13:\*.asf=38\;5\;13:\*.rm=38\;5\;13:\*.rmvb=38\;5\;13:\*.flc=38\;5\;13:\*.avi=38\;5\;13:\*.fli=38\;5\;13:\*.flv=38\;5\;13:\*.gl=38\;5\;13:\*.dl=38\;5\;13:\*.xcf=38\;5\;13:\*.xwd=38\;5\;13:\*.yuv=38\;5\;13:\*.cgm=38\;5\;13:\*.emf=38\;5\;13:\*.axv=38\;5\;13:\*.anx=38\;5\;13:\*.ogv=38\;5\;13:\*.ogx=38\;5\;13:\*.aac=38\;5\;45:\*.au=38\;5\;45:\*.flac=38\;5\;45:\*.mid=38\;5\;45:\*.midi=38\;5\;45:\*.mka=38\;5\;45:\*.mp3=38\;5\;45:\*.mpc=38\;5\;45:\*.ogg=38\;5\;45:\*.ra=38\;5\;45:\*.wav=38\;5\;45:\*.axa=38\;5\;45:\*.oga=38\;5\;45:\*.spx=38\;5\;45:\*.xspf=38\;5\;45:; export LS_COLORS
LC_TELEPHONE=vi_VN; export LC_TELEPHONE
MAIL=/var/spool/mail/root; export MAIL
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin; export PATH
LC_IDENTIFICATION=vi_VN; export LC_IDENTIFICATION
PWD=/root; export PWD
LANG=en_US.UTF-8; export LANG
LC_MEASUREMENT=vi_VN; export LC_MEASUREMENT
HISTCONTROL=ignoredups; export HISTCONTROL
SHLVL=1; export SHLVL
HOME=/root; export HOME
LESS=-X; export LESS
LOGNAME=root; export LOGNAME
SSH_CONNECTION=171.252.189.201\ 5216\ 10.10.3.193\ 22; export SSH_CONNECTION
LESSOPEN=\|\|/usr/bin/lesspipe.sh\ %s; export LESSOPEN
PROMPT_COMMAND=RETRN_VAL=0\;logger\ -p\ local6.debug\ \"[\$\(echo\ \$SSH_CLIENT\ \|\ cut\ -d\"\ \"\ -f1\)]\ #\ \$\(history\ 1\ \|\ sed\ \"s/\^[\ ]\*[0-9]\\+[\ ]\*//\"\ \)\"; export PROMPT_COMMAND
XDG_RUNTIME_DIR=/run/user/0; export XDG_RUNTIME_DIR
LC_TIME=vi_VN; export LC_TIME
HISTTIMEFORMAT=%d/%m/%y\ %T\ ; export HISTTIMEFORMAT
LC_NAME=vi_VN; export LC_NAME
cd /root || {
         echo 'Execution directory inaccessible' >&2
         exit 1
}
${SHELL:-/bin/sh} << 'marcinDELIMITER60fa340f'

marcinDELIMITER60fa340f
[root@huyvl-linux-training ~]# 
```

Lệnh `at -d` hoặc `atrm` để xóa tác vụ trước khi nó được chạy:

```shell
[root@huyvl-linux-training ~]# echo hello | at now +1min
job 17 at Sun Dec 24 18:00:00 2023
[root@huyvl-linux-training ~]# atq
17      Sun Dec 24 18:00:00 2023 a root
[root@huyvl-linux-training ~]# at -d 17
[root@huyvl-linux-training ~]# atq
[root@huyvl-linux-training ~]# echo hello | at now +1min
job 18 at Sun Dec 24 18:00:00 2023
[root@huyvl-linux-training ~]# atq
18      Sun Dec 24 18:00:00 2023 a root
[root@huyvl-linux-training ~]# atrm 18
[root@huyvl-linux-training ~]# atq
[root@huyvl-linux-training ~]# 
```

Sử dụng hàng đợi `b` thông qua lệnh `batch` hoặc `at -q b`. Với hàng đợi `b` không thực thi dựa trên thời gian mà phụ thuọc vào tải hiện tại của hệ thống, mặc định sẽ chạy bât kể khi nào tải hệ thống dưới `9.8`. Vì vậy việc chỉ định thời gian sẽ vô nghĩa.

```shell
[root@huyvl-linux-training ~]# date        
Sun Dec 24 18:33:54 +07 2023
[root@huyvl-linux-training ~]# ls
[root@huyvl-linux-training ~]# mkdir hello | batch
job 34 at Sun Dec 24 18:34:00 2023
[root@huyvl-linux-training ~]# atq
[root@huyvl-linux-training ~]# atq
[root@huyvl-linux-training ~]# ls
hello
[root@huyvl-linux-training ~]# mkdir hi | batch
job 35 at Sun Dec 24 18:34:00 2023
[root@huyvl-linux-training ~]# atq
35      Sun Dec 24 18:34:00 2023 b root
[root@huyvl-linux-training ~]#
```

Người dùng `root` có thể thiết lập chính sách cho phép hoặc từ chối người dùng khác sử dụng công cụ `at` hoặc `batch`. Nội dung được liệt kê theo dòng trong `/etc/at.allow` hoặc `/etc/at.deny`. Quy tắc rằng nếu `/etc/at.allow` tồn tại thì `/etc/at.deny` sẽ được bỏ qua và ngược lại. Sau khi chỉnh sửa thì không cần khởi động lại `atd`.

```shell
[root@huyvl-linux-training etc]# ls | grep ^at
at.deny
[root@huyvl-linux-training etc]# cat /etc/at.deny 
[root@huyvl-linux-training etc]# 
[root@huyvl-linux-training etc]# su - hn
Last login: Sun Dec 24 20:14:50 +07 2023 on pts/1
[hn@huyvl-linux-training ~]$ 
[hn@huyvl-linux-training ~]$ echo `date` > now.txt | at now
job 53 at Sun Dec 24 20:15:00 2023
[hn@huyvl-linux-training ~]$ cat now.txt 
Sun Dec 24 20:15:42 +07 2023
[hn@huyvl-linux-training ~]$ exit
logout
[root@huyvl-linux-training etc]# echo hn > /etc/at.deny 
[root@huyvl-linux-training etc]# su - hn
Last login: Sun Dec 24 20:15:26 +07 2023 on pts/1
[hn@huyvl-linux-training ~]$ echo `date` > now.txt | at now
You do not have permission to use at.
[hn@huyvl-linux-training ~]$ 
```

### <a name="cron"></a>Cách sử dụng `cron`

`crontab` là chương trình triển khai dạng `recurring` nên công việc sẽ được lặp lại theo mỗi chu kỳ. Mỗi người dùng đều có riêng cho mình một tệp cấu hình mà họ có thể chỉnh sửa thông qua lệnh `crontab -e`.

Lệnh `crontab -e` sẽ gọi trình soạn thảo `vim bởi mặc định, người dùng cũng có thể thay đổi sang trình soạn thảo khác.

```shell
[root@huyvl-linux-training ~]# echo export EDITOR=/usr/bin/vim >> ~/.bashrc
[root@huyvl-linux-training ~]# . ~/.bashrc 
[root@huyvl-linux-training ~]# echo $EDITOR
/usr/bin/vim
[root@huyvl-linux-training ~]#l
```

Định dạng nội dung cho mỗi tác vụ đều là thời điểm. Mô tả thông qua 5 ví dụ sau:

| Phút | Giờ | Ngày | Tháng | Số thứ tự trong tuần | Ví dụ thực thi | Giải thích |
| --- | --- | --- | --- | --- | --- | --- |
| 0 | 14:00 | 13 | 6 | 1 | /bin/true | Bất kể khi nào ngày 13/6 là đầu tuần sẽ thì lúc 2 giờ chiều sẽ thực hiện `/bin/true`. |
| 0 | 14:00 | 14 | 6 | * | /bin/true | Cứ mỗi lần ngày 14/6 lúc 2 giờ chiều sẽ thực hiện `/bin/true`. |
| 0 | 14:00 | * | 5 | 1-5 | /bin/true | Cứ mỗi 2 giờ chiều ngày hành chính trong tháng 5 sẽ thực hiện `/bin/true`. |
| 15,45 | 08,11,14 | * | * | 1-5 | /bin/true | Cứ mỗi giờ đó ngày hành chính sẽ thực hiện `/bin/true`. |
| */10 | * | * | * | * | /bin/true | Cứ mỗi 10 phút sẽ thực hiện `/bin/true`. |

Ví dụ cứ mỗi 1 phút sẽ viết lại ngày giờ vào tệp. Sử dụng tùy chọn `-u` để xem nội dung `crontab` của người dùng khác.

```shell
[hn@huyvl-linux-training root]$ crontab -e
no crontab for hn - using an empty one
crontab: installing new crontab
[hn@huyvl-linux-training root]$ exit
exit
[root@huyvl-linux-training ~]# crontab -l -u hn
*/1 * * * * echo `date` >> date.txt
[root@huyvl-linux-training ~]# cat /home/hn/date.txt
Sun Dec 24 22:41:01 +07 2023
Sun Dec 24 22:42:01 +07 2023
[root@huyvl-linux-training ~]#
```

Sử dụng tùy chọn `-r` để xóa nội dung của người dùng khác:

```shell
[root@huyvl-linux-training ~]# crontab -l -u hn
*/1 * * * * echo `date` >> date.txt
[root@huyvl-linux-training ~]# crontab -r -u hn
[root@huyvl-linux-training ~]# crontab -l -u hn
no crontab for hn
[root@huyvl-linux-training ~]#
[root@huyvl-linux-training ~]# cat /var/spool/cron/hn
cat: /var/spool/cron/hn: No such file or directory
[root@huyvl-linux-training ~]# 
```

Cách tốt nhất để chạy các tác vụ là dưới quyền quản trị viên thay vì tài khoản người dùng thông thường. Để làm được việc này cần định nghĩa tệp `crontab` hệ thống thay vì sử dụng lệnh `crontab`. Tệp `crontab` hệ thống khác ở chỗ có thêm trường nằm phía trước lệnh để chỉ định tài khoản người dùng sẽ thực thi.

```shell
[root@huyvl-linux-training ~]# cat /etc/crontab 
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed

[root@huyvl-linux-training ~]# 
```

`crontab` hệ thống cũng cho phép sử dụng `drop-in` thông qua thư mục `/etc/cron.d/` để tránh mất những cài đặt như hướng dẫn trước khi nâng cấp phần mềm. Hệ thống `crontab` sẽ chạy tất cả các `shellscript` có trong thư mục `/etc/cron.hourly` như ví dụ sau:

```shell
[root@huyvl-linux-training ~]# ls /etc/cron.d/
0hourly
[root@huyvl-linux-training ~]# cat /etc/cron.d/0hourly 
# Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
01 * * * * root run-parts /etc/cron.hourly
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# ls -l /etc/cron.hourly
total 4
-rwxr-xr-x. 1 root root 392 Jan 13  2022 0anacron
[root@huyvl-linux-training ~]# cat /etc/cron.hourly/0anacron 
#!/bin/sh
# Check whether 0anacron was run today already
if test -r /var/spool/anacron/cron.daily; then
    day=`cat /var/spool/anacron/cron.daily`
fi
if [ `date +%Y%m%d` = "$day" ]; then
    exit 0;
fi

# Do not run jobs when on battery power
if test -x /usr/bin/on_ac_power; then
    /usr/bin/on_ac_power >/dev/null 2>&1
    if test $? -eq 1; then
    exit 0
    fi
fi
/usr/sbin/anacron -s
[root@huyvl-linux-training ~]#  
```

Chú thích:

- Tệp được đặt tên `/etc/cron.d/0hourly`, quản trị viên có thể sử dụng tên khác tùy ý.
- Cứ mỗi giờ vào lúc phút thứ `01` sẽ thực hiện tác vụ.
- Tác vụ chạy dưới quyền `root`.
- Từ khóa `run-parts` chấp nhận thư mục là tham số của lệnh, mô tả chạy tất cả `shellscript` có trong thư mục `/etc/cron.hourly`.
- Tệp `/etc/cron.hourly/0anacron` đã được cấp quyền thực thi.
- Gửi kết quả vào hòm thư điện tử  `MAILTO`, ví dụ thay đổi thành `root@yahoo.com`.

Từ khóa `run-parts` cũng được sử dụng trong cấu hình `anacrontab`. Tệp `anacrontab` đảm bảo các tác vụ được lập lịch luôn chạy và không bị vô tình bỏ qua do hệ thống bị tắt hoặc trạng thái ngủ. Ví dụ tác vụ chạy không thể thực thi khi hệ thống đang khởi động lại thì tác vụ sẽ thực thi ngay khi hệ thống sẵn sàng.

```shell
[root@huyvl-linux-training ~]# cat /etc/anacrontab 
# /etc/anacrontab: configuration file for anacron

# See anacron(8) and anacrontab(5) for details.

SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
# the maximal random delay added to the base delay of the jobs
RANDOM_DELAY=45
# the jobs will be started during the following hours only
START_HOURS_RANGE=3-22

#period in days   delay in minutes   job-identifier   command
1       5       cron.daily              nice run-parts /etc/cron.daily
7       25      cron.weekly             nice run-parts /etc/cron.weekly
@monthly 45     cron.monthly            nice run-parts /etc/cron.monthly
[root@huyvl-linux-training ~]# 
```

Chú thích:

- Biến `RANDOM_DELAY` sẽ trì hoãn tối đa `45` phút trước khi thực thi.
- Biến `START_HOURS_RANGE` chỉ định khung giờ mà `run-parts` hoạt động, thời điểm có hiệu lực là `3:00(AM)` và hết hiệu lực lúc `10:00(PM)`.
- Giá trị `1` của biến `period in days` đại diện cho mỗi ngày. Có thể sử dụng tên khác như `@daily`, `@weekly`, `@monthly`.
- Trì hoãn `5` phút của `delay in minutes` trước khi bắt đầu. Nếu để là `0` thì không trì hoãn.
- Biến `job-identifier` chỉ định tên duy nhất của tác vụ.
- Lệnh `nice` mô tả độ ưu tiên lên cao nhất cho lệnh chính `run-parts /etc/cron.daily` lên cao nhất, có thể điều chỉnh độ ưu tiên khác.

### <a name="systemd_timer"></a>Ứng dụng `systemd timer`
#### <a name="systemd_timer_basic"></a>Cách sử dụng công cụ `systemd timer`

Ví dụ sử dụng `systemd timer` để  lặp lại công việc mỗi 1 phút:

```shell
[root@huyvl-linux-training system]# pwd
/usr/lib/systemd/system
[root@huyvl-linux-training system]# cat sysstat.timer 
[Unit]
Description=Run system activity accounting tool every 10 minutes

[Timer]
OnCalendar=*:00/1

[Install]
WantedBy=sysstat.service
[root@huyvl-linux-training system]# 
[root@huyvl-linux-training system]# cat sysstat.service 
[Unit]
Description="Hello"

[Service]
Type=simple
ExecStart=/usr/bin/bash -c "echo `date` > /root/hello.log"
[root@huyvl-linux-training system]# systemctl daemon-reload
[root@huyvl-linux-training system]# systemctl enable --now sysstat.timer
[root@huyvl-linux-training system]#
[root@huyvl-linux-training system]# cat /root/hello.log 
Mon Jan 1 14:40:00 +07 2024
Mon Jan 1 14:41:00 +07 2024
Mon Jan 1 14:42:00 +07 2024
[root@huyvl-linux-training system]# 
```

Chú thích: tùy chọn `OnCalendar=*:00/1` mô tả rằng `sysstat.timer` sẽ chạy `sysstat.service` mỗi phút.

Người dùng có thể tùy biến thêm để đáp ứng nhu cầu ví dụ như `OnCalendar=2024-01-* 14:35,37,39:16` để lập lịch chạy mỗi ngày trong tháng 1 sẽ chạy vào các thời điểm `14:35:16` và `14:37:16` và `14:39:16`. Thêm vào đó sử dụng kèm tùy chọn `OnUnitActiveSec=3min` để chạy sau 3 phút kể từ lần gần nhất `systat.service` được khởi động và giữ nguyên chu kỳ.

```shell
[root@huyvl-linux-training ~]# systemctl status sysstat.service
* sysstat.service - "Hello"
   Loaded: loaded (/usr/lib/systemd/system/sysstat.service; static; vendor preset: enabled)
   Active: inactive (dead) since Mon 2024-01-01 15:02:01 +07; 1min 22s ago 
  Process: 11508 ExecStart=/usr/bin/bash -c echo `date` >> /root/hello.log (code=exited, status=0/SUCCESS)
 Main PID: 11508 (code=exited, status=0/SUCCESS)

Jan 01 15:05:01 huyvl-linux-training.novalocal systemd[1]: Started "Hello".
[root@huyvl-linux-training ~]# date
Mon Jan  1 15:02:36 +07 2024
[root@huyvl-linux-training ~]# vi /usr/lib/systemd/system/sysstat.timer
[root@huyvl-linux-training ~]# cat /usr/lib/systemd/system/sysstat.timer
[Unit]
Description=Run system activity accounting tool every 10 minutes

[Timer]
#OnCalendar=*:00/1
OnCalendar=2024-01-* 15:02:00
OnUnitActiveSec=3min

[Install]
WantedBy=sysstat.service
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# systemctl daemon-reload
[root@huyvl-linux-training ~]#
[root@huyvl-linux-training ~]# cat hello.log
Mon Jan 1 15:00:01 +07 2024
Mon Jan 1 15:01:01 +07 2024
Mon Jan 1 15:02:01 +07 2024
Mon Jan 1 15:05:01 +07 2024
Mon Jan 1 15:08:01 +07 2024
Mon Jan 1 15:11:01 +07 2024
[root@huyvl-linux-training ~]#
```

#### <a name="manage_tmp_file"></a>Quản lý loại tệp tạm thời

Hầu hết các ứng dụng quan trọng đều sử dụng tệp hoặc thư mục tạm thời. Một số ứng dụng và người dùng sử dụng thư mục `/tmp` để giữ dữ liệu tạm thời, trong khi các ứng dụng khác sử dụng thư mục riêng ví dụ như `/run` là nơi chỉ tồn tại trên bộ nhớ.

Thông thường các ứng dụng sẽ hoạt động dúng cách khi tệp và thư mục tạm thời của nó tồn tại. Thêm vào đó việc xóa các tệp tạm thời trên ổ cứng là sự cần thiết để tránh khỏi các vấn đề hết dung lượng. Các bản phân phối `CentOS` sử dụng công cụ `systemd-tmpfiles` cung cấp phương pháp cấu hình `*.conf` để quản lý tệp và thư mục tạm thời như:

- Tùy chọn `--create`: tạo thư mục, tệp.
- Tùy chọn `--clean`: xóa dựa trên độ tuổi của tệp và thư mục con.
- Tùy chọn `--remove`: xóa tệp trong thư mục hoặc bản thân chính thư mục đó.
- Tùy chọn `--boot`: thực thi các dòng được chỉ định là chỉ hoạt động an toàn khi khởi động hệ thống, ngoài ra có thể gây chết hệ thống nếu ngoài mục đích đó.
- Tùy chọn `--exclude-prefix=`: bỏ qua những dòng bắt đầu vào giá trị này.
- Tùy chọn `--prefix=`: chỉ áp dụng lên những dòng bắt đầu bằng giá trị này.
- Tùy chọn `--root=`: thêm giá trị này vào tiền tố cho tất cả đường dẫn.

Các tệp cấu hình `*.conf` sẽ nằm ở trong các thư mục sau:

```shell
[root@huyvl-linux-training ~]# man tmpfiles.d
TMPFILES.D(5)                               tmpfiles.d                               TMPFILES.D(5)

NAME
       tmpfiles.d - Configuration for creation, deletion and cleaning of volatile and temporary files
SYNOPSIS
       /etc/tmpfiles.d/*.conf
       /run/tmpfiles.d/*.conf
       /usr/lib/tmpfiles.d/*.conf
...
```

Những tệp trong `/etc/tmpfiles.d/` sẽ ghi đè `/usr/lib/tmpfiles.d/` và `/run/tmpfiles.d/`. Những tệp trong `/run/tmpfiles.d/` sẽ ghi đè `/usr/lib/tmpfiles.d/`. Cú pháp của các tệp `*.conf` gồm 6 thuộc tính: 

- `Type`: đại đa số được sử dụng bởi `--create`, `--remove` và `--boot`. Ví dụ như tạo thư mục với `d`, xóa nội dung bên trong với `D`... Với các thuộc tính có thêm dấu `!`(ví dụ `r!`) thông báo rằng nó chỉ an toàn khi chạy khởi máy hệ thống và có thể gây ra lỗi hệ thống, với những thuộc tính không có dấu `!` sẽ an toàn để thực thi trong mọi tình huống.
- `Path`: đường dẫn đến tệp hoặc thư mục.
- `Mode`: [quyền truy cập](https://github.com/volehuy1998/network-onboard/blob/master/linux-onboard/2.3%20-%20linux-file-system-overview.md#file_permission), có thể dùng hệ bát phân hoặc chi tiết.
- `UID`, `GID`: người và nhóm sở hữu.
- `Age`: dựa trên thời gian tạo mà thư mục hoặc tệp sẽ bị xóa. Chỉ được sử dụng bởi `--clean`. 

Khi hệ thống được khởi động thì một trong những dịch vụ đầu tiên được chạy là `systemd-tmpfiles-setup.service`.

```shell
[root@huyvl-linux-training ~]# systemctl cat systemd-tmpfiles-setup.service
# /usr/lib/systemd/system/systemd-tmpfiles-setup.service
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Create Volatile Files and Directories
Documentation=man:tmpfiles.d(5) man:systemd-tmpfiles(8)
DefaultDependencies=no
Conflicts=shutdown.target
After=systemd-readahead-collect.service systemd-readahead-replay.service local-fs.target systemd-sysusers.service
Before=sysinit.target shutdown.target
RefuseManualStop=yes

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/systemd-tmpfiles --create --remove --boot --exclude-prefix=/dev
[root@huyvl-linux-training ~]# 
```

Chú thích:

- Thứ tự tùy chọn `--create` và `--remove` để đảm bảo rằng thư mục sẽ trống.
- Tùy chọn `--exclude-prefix` mô tả bỏ qua tát cả các luật mà đường dẫn bắt đầu bằng `/dev`.
- Trong lệnh không chỉ định cụ thể tệp cấu hình `*.conf` nên mặc định sẽ lấy tất cả.

Có thể sử dụng biến mỗi trường để mở chế độ xem chi tiết một cách tự động thông qua `journalctl`:

```shell
[root@huyvl-linux-training ~]# tail -n 3 .bashrc
#export SYSTEMD_LOG_LEVEL=debug
#export SYSTEMD_LOG_TARGET=journal-or-kmsg
#export SYSTEMD_LOG_LOCATION=true
[root@huyvl-linux-training ~]# 
```
##### <a name="tmpfiles_create"></a>Cách sử dụng `systemd-tmpfiles --create`

Tạo thư mục `d` và mặc định quyền `0755` khi quyền truy cập là `-`. Với hành động `--create` thì liên quan đến `Age` nên tiếp tục chỉ định `-`.

```shell
[root@huyvl-linux-training ~]# ls -ld /run/admin-debug
ls: cannot access /run/admin-debug: No such file or directory
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
d /run/admin-debug - root root -
[root@huyvl-linux-training ~]# SYSTEMD_LOG_LEVEL=debug systemd-tmpfiles --create /etc/tmpfiles.d/run.conf
Reading config file "/etc/tmpfiles.d/run.conf".
Running create action for entry d /run/admin-debug
Created directory "/run/admin-debug".
[root@huyvl-linux-training ~]# ls -ld /run/admin-debug
drwxr-xr-x 2 root root 40 Jan  1 22:51 /run/admin-debug
[root@huyvl-linux-training ~]# 
```

Tạo tệp với `Type` là `F` như sau:

```shell
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
F /run/admin-debug/kernel.log - root root -
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# ls -l /run/admin-debug/kernel.log
ls: cannot access /run/admin-debug/kernel.log: No such file or directory
[root@huyvl-linux-training ~]# systemd-tmpfiles --create /etc/tmpfiles.d/run.conf
[root@huyvl-linux-training ~]# ls -l /run/admin-debug/kernel.log
-rw-r--r-- 1 root root 0 Jan  1 23:06 /run/admin-debug/kernel.log
[root@huyvl-linux-training ~]# 
```

Khi tệp đã có dữ liệu thì làm rỗng tệp bằng cách chạy lại lệnh ví dụ vừa rồi:

```shell
[root@huyvl-linux-training ~]# echo test > /run/admin-debug/kernel.log
[root@huyvl-linux-training ~]# cat /run/admin-debug/kernel.log
test
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
F /run/admin-debug/kernel.log - root root -
[root@huyvl-linux-training ~]# systemd-tmpfiles --create /etc/tmpfiles.d/run.conf
[root@huyvl-linux-training ~]# cat /run/admin-debug/kernel.log
[root@huyvl-linux-training ~]# 
```

Tạo tệp có dữ liệu thông qua `Type` là `f` và thuộc tính `Argument` thứ 7 như sau:

```shell
[root@huyvl-linux-training ~]# cat /run/admin-debug/kernel.log
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
f /run/admin-debug/kernel.log - root root - "Hello this is a text"
[root@huyvl-linux-training ~]# SYSTEMD_LOG_LEVEL=debug systemd-tmpfiles --create /etc/tmpfiles.d/run.conf
Reading config file "/etc/tmpfiles.d/run.conf".
Running create action for entry f /run/admin-debug/kernel.log
Appending to "/run/admin-debug/kernel.log".
[root@huyvl-linux-training ~]# cat /run/admin-debug/kernel.log
Hello this is a text[root@huyvl-linux-training ~]# 
```

##### <a name="tmpfiles_clean"></a>Cách sử dụng `systemd-tmpfiles --clean`

Khi giá trị `Age` là `0` thì sẽ xóa tất cả tệp và thư mục mà không cần điều kiện. Nếu có nhiều giá trị thì `systemd-tmpfiles` sẽ tính tổng cộng, các đơn vị có thể sử dụng như:

- Giây: `s` (mặc định nếu không khai đơn vị).
- Phút: `m`.
- Giờ: `h`.
- Ngày: `d`.
- Tuần: `w`.
- Milliseconds: `ms`.
- Microseconds: `us`.

Để tránh khỏi việc hết dung lượng ổ cứng khi hệ thống chạy quá lâu thì `systemd-tmpfiles-clean.timer` sẽ tự động gọi `systemd-tmpfiles-clean.service` thực thi `systemd-tmpfiles --clean`. Trong tệp `timer` này mô tả điều kiện để khởi động.

```shell
[root@huyvl-linux-training ~]# systemctl cat systemd-tmpfiles-clean.timer 
# /usr/lib/systemd/system/systemd-tmpfiles-clean.timer
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Daily Cleanup of Temporary Directories
Documentation=man:tmpfiles.d(5) man:systemd-tmpfiles(8)

[Timer]
OnBootSec=15min
OnUnitActiveSec=1d
[root@huyvl-linux-training ~]# 
```

Trong tệp cấu hình `/usr/lib/tmpfiles.d/tmp.conf` mô tả rằng các tệp và thư mục con được tạo hơn `10` ngày trước trong `/tmp` sẽ bị xóa.

```shell
[root@huyvl-linux-training ~]# cat /usr/lib/tmpfiles.d/tmp.conf
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# See tmpfiles.d(5) for details

# Clear tmp directories separately, to make them easier to override
v /tmp 1777 root root 10d
v /var/tmp 1777 root root 30d

# Exclude namespace mountpoints created with PrivateTmp=yes
x /tmp/systemd-private-%b-*
X /tmp/systemd-private-%b-*/tmp
x /var/tmp/systemd-private-%b-*
X /var/tmp/systemd-private-%b-*/tmp
[root@huyvl-linux-training ~]# 
```

Quản trị cũng có thể chủ động gọi thông qua tùy chọn `systemd-tmpfiles --clean`. Ví dụ xóa tất cả tệp trong thư mục tạm `/tmp` nếu chúng không được sử dụng trong `10(s)`. Công cụ `systemd-tmpfiles --clean` chỉ quan tâm đến đường dẫn và độ tuổi có thể xóa.

```shell
[root@huyvl-linux-training ~]# touch /tmp/docker.log 
[root@huyvl-linux-training ~]# mkdir -pv /tmp/spin
mkdir: created directory '/tmp/spin'
[root@huyvl-linux-training ~]#      
[root@huyvl-linux-training ~]# ls -l /tmp/
total 4
-rw-r--r-- 1 root root    0 Jan  1 20:38 docker.log
drwxr-xr-x 2 root root 4096 Jan  1 20:38 spin
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/tmp.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/tmp.conf 
d /tmp - root root 10s
[root@huyvl-linux-training ~]# date
Mon Jan  1 20:39:44 +07 2024
[root@huyvl-linux-training ~]# systemd-tmpfiles --clean /etc/tmpfiles.d/tmp.conf 
[root@huyvl-linux-training ~]# ls -l /tmp/
total 0
[root@huyvl-linux-training ~]# 
```

Sử dụng dấu `-` tại thuộc tính `Age` để vô hiệu hóa tùy chọn `--clean` như sau:

```shell
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/tmp.conf 
d /tmp - root root -
[root@huyvl-linux-training ~]# ls -l /tmp/
total 0
-rw-r--r-- 1 root root 0 Jan  1 21:35 a.log
[root@huyvl-linux-training ~]# systemd-tmpfiles --clean /etc/tmpfiles.d/tmp.conf 
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# ls -l /tmp/
total 0
-rw-r--r-- 1 root root 0 Jan  1 21:35 a.log
[root@huyvl-linux-training ~]#
```

Sử dụng dấu `~` trước thời gian để chỉ áp dụng cho các tệp và thư mục ở cấp độ thứ `2` trở đi, còn các tệp và thư mục liền kề bên trong sẽ được bỏ qua như sau:

```shell
[root@huyvl-linux-training ~]# mkdir -pv /tmp/a/a1/a2
mkdir: created directory '/tmp/a'
mkdir: created directory '/tmp/a/a1'
mkdir: created directory '/tmp/a/a1/a2'
[root@huyvl-linux-training ~]# mkdir -pv /tmp/b
mkdir: created directory '/tmp/b'
[root@huyvl-linux-training ~]# touch /tmp/b/date.log
[root@huyvl-linux-training ~]# touch /tmp/a/a1/a2/date.log
[root@huyvl-linux-training ~]# touch /tmp/temp.log
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# tree /tmp
/tmp
|-- a
|   `-- a1
|       `-- a2
|           `-- date.log
|-- b
|   `-- date.log
|-- temp.log

4 directories, 3 files
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/tmp.conf 
d /tmp - - - ~5s
[root@huyvl-linux-training ~]# SYSTEMD_LOG_LEVEL=debug systemd-tmpfiles --clean /etc/tmpfiles.d/tmp.conf
Reading config file "/etc/tmpfiles.d/tmp.conf".
Running clean action for entry d /tmp
Cleanup threshold for directory "/tmp" is Mon 2024-01-01 22:36:49.886426 +07
unlink "/tmp/a/a1/a2/date.log"
Restoring access and modification time on "/tmp/a/a1/a2": Mon 2024-01-01 22:36:31.429123 +07, Mon 2024-01-01 22:36:43.804210 +07
Removing directory "/tmp/a/a1/a2".
Removing directory "/tmp/a/a1".
Keeping "/tmp/a".
Keeping "/tmp/temp.log".
unlink "/tmp/b/date.log"
Restoring access and modification time on "/tmp/b": Mon 2024-01-01 22:35:12.801573 +07, Mon 2024-01-01 22:36:40.189185 +07
Keeping "/tmp/b".
[root@huyvl-linux-training ~]#
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# tree /tmp
/tmp
|-- a
|-- b
|-- temp.log

2 directories, 1 file
[root@huyvl-linux-training ~]# 
```

Giá trị `-` tại trường `Path` sẽ báo lỗi vì nó không được cho phép:

```shell
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/tmp.conf
d - - - - ~5s
[root@huyvl-linux-training ~]# systemd-tmpfiles --clean /etc/tmpfiles.d/tmp.conf
[/etc/tmpfiles.d/tmp.conf:1] Path '-' not absolute.
[root@huyvl-linux-training ~]# 
```

##### <a name="tmpfiles_remove"></a>Cách sử dụng `systemd-tmpfiles --remove`

Xóa thư mục trống `/run/admin-debug/` sử dụng tùy chọn `--remove` như sau:

```shell
[root@huyvl-linux-training ~]# mkdir -pv /run/admin-debug
mkdir: created directory '/run/admin-debug'
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf
r /run/admin-debug - - - -
[root@huyvl-linux-training ~]# systemd-tmpfiles --remove /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# ls -ld /run/admin-debug
ls: cannot access /run/admin-debug: No such file or directory
[root@huyvl-linux-training ~]#
```

Xóa thư mục có dữ liệu cần `Type` là `R` thay vì `r` của thư mục trống:

```shell
[root@huyvl-linux-training ~]# mkdir -pv /run/admin-debug
mkdir: created directory '/run/admin-debug'
[root@huyvl-linux-training ~]# touch /run/admin-debug/kernel.log
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf
r /run/admin-debug - - - -
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# systemd-tmpfiles --remove /etc/tmpfiles.d/run.conf 
rm(/run/admin-debug): Directory not empty
[root@huyvl-linux-training ~]#
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf
R /run/admin-debug - - - -
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# systemd-tmpfiles --remove /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# ls -ld /run/admin-debug
ls: cannot access /run/admin-debug: No such file or directory
[root@huyvl-linux-training ~]# 
```

Giá trị `-` tại đường dẫn sẽ báo lỗi vì nó không được cho phép:

```shell
[root@huyvl-linux-training ~]# mkdir -pv /run/admin-debug
mkdir: created directory '/run/admin-debug'
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
d - - - - -
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# 
[root@huyvl-linux-training ~]# systemd-tmpfiles --remove /etc/tmpfiles.d/run.conf 
[/etc/tmpfiles.d/run.conf:1] Path '-' not absolute.
[root@huyvl-linux-training ~]#
```

Làm rỗng thư mục với `Type` là `D` khi thư mục đã tồn tại:

```shell
[root@huyvl-linux-training ~]# tree /run/admin-debug           
/run/admin-debug
|-- kernel.log

0 directories, 1 file
[root@huyvl-linux-training ~]# vi /etc/tmpfiles.d/run.conf 
[root@huyvl-linux-training ~]# cat /etc/tmpfiles.d/run.conf 
D /run/admin-debug - root root -
[root@huyvl-linux-training ~]# SYSTEMD_LOG_LEVEL=debug systemd-tmpfiles --remove /etc/tmpfiles.d/run.conf
Reading config file "/etc/tmpfiles.d/run.conf".
Running remove action for entry D /run/admin-debug
rm -rf "/run/admin-debug"
[root@huyvl-linux-training ~]# 
```